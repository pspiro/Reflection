#!/bin/bash

# this file gets modified when we run the program, but we don't want to keep the changes
git restore .googfiles/StoredCredential

git pull
echo
echo "Expect '[WARNING] Unrecognised tag: blocked' during build process"
echo
# move jar file aside so we don't disturb running instance and we can blow away
# target folder if desired
rm old.jar
mv target/Reflection-0.0.2-jar-with-dependencies.jar old.jar

mvn package | tee build.out

if ! grep -q "BUILD SUCCESS" build.out; then
  echo failure
  exit 1
fi

# must restart all servers or you can get classnotfound errors
# (might not be true anymore since we move running jar aside)

#don't run tgserver in prod, only in dev (soon to change)
#echo restarting tgserver
#sudo systemctl restart tgserver
#sleep 2
echo restarting hookserver
sudo systemctl restart hookserver
sleep 2

echo restarting mdserver
sudo systemctl restart mdserver
sleep 2

#echo restarting fbserver
#sudo systemctl restart fbserver
#sleep 2

echo restarting refapi
sudo systemctl restart refapi
